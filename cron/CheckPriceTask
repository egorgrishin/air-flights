#!/usr/bin/php
<?php
declare(strict_types=1);

use App\Core\Telegram;
use App\Enums\TelegramMethod;
use App\Repositories\PriceRepository;
use App\Repositories\SubscriptionsRepository;
use App\Services\GetPriceService;
use App\VO\Price;
use App\VO\Subscription;

require __DIR__ . '/../vendor/autoload.php';

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—ã –Ω–∞ –∞–≤–∏–∞–±–∏–ª–µ—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –ø–æ–¥–ø–∏—Å–∫–∞–º
 *
 * @param Subscription[] $subscriptions
 * @return Price[][]
 */
function getOldPrices(array $subscriptions): array
{
    global $priceRepository;
    $subscriptionIds = array_column($subscriptions, 'id');
    $prices = $subscriptionIds ? $priceRepository->get($subscriptionIds) : [];
    $data = array_fill_keys($subscriptionIds, []);

    foreach ($prices as $price) {
        if (!array_key_exists($price->subscriptionId, $data)) {
            continue;
        }
        $data[$price->subscriptionId][$price->companyCode] = $price;
    }

    return $data;
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Ü–µ–Ω –Ω–∞ –±–∏–ª–µ—Ç—ã, –∫—ç—à–∏—Ä—É—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–∫—Ä–∏–ø—Ç–∞
 * 
 * @param Subscription $subscription
 * @return array
 */
function getPrices(Subscription $subscription): array
{
    global $temp;
    $key = "$subscription->id.$subscription->depCode.$subscription->arrCode";
    if (!empty($temp[$key])) {
        return $temp[$key];
    }

    return $temp[$key] = (new GetPriceService())->run(
        $subscription->id,
        $subscription->depCode,
        $subscription->arrCode,
        DateTime::createFromFormat('Y-m-d', $subscription->date),
    );
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã –≤ Telegram
 *
 * @param Subscription $subscription
 * @param Price[] $prices
 * @param Price[] $oldPrices
 * @return void
 */
function checkPrices(Subscription $subscription, array $prices, array $oldPrices): void
{
    $oldPrices = array_filter(array_column($oldPrices, 'price'));
    $prices = array_filter(array_column($prices, 'price'));
    // –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç —Ü–µ–Ω—ã, —Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ
    if (empty($prices)) {
        return;
    }
    $date = DateTime::createFromFormat('Y-m-d', $subscription->date)->format('d.m.Y');
    $minPrice = min($prices);
    $formattedPrice = number_format($minPrice, 0, ',', ' ');
    $telegram = new Telegram();
    // –°—Ç–∞—Ä—ã–µ —Ü–µ–Ω—ã –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã, –µ—Å–ª–∏ –Ω–æ–≤—ã–µ —Ü–µ–Ω—ã –Ω–µ –±—É–¥—É—Ç –ø–æ–ª—É—á–µ–Ω—ã —Å API
    if (empty($oldPrices)) {
        $text = <<<TEXT
                üóì –î–∞—Ç–∞: $date

                ‚úàÔ∏è $subscription->depTitle ‚Äî $subscription->arrTitle 

                ‚úÖ –¶–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ 
                üíµ $formattedPrice ‚ÇΩ
                TEXT;
        $telegram->send(TelegramMethod::Send, [
            'chat_id' => $subscription->chatId,
            'text'    => $text,
        ]);
        return;
    }

    $minOldPrice = min($oldPrices);
    if ($minPrice === $minOldPrice) {
        return;
    }
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã
    $verb = $minPrice < $minOldPrice ? '—É–º–µ–Ω—å—à–∏–ª–∞—Å—å' : '—É–≤–µ–ª–∏—á–∏–ª–∞—Å—å';
    $emoji = $minPrice < $minOldPrice ? 'üìâ' : 'üìà';
    $diff = abs($minPrice - $minOldPrice);
    $formattedDiff = number_format($diff, 0, ',', ' ');
    $text = <<<TEXT
            üóì –î–∞—Ç–∞: $date

            ‚úàÔ∏è $subscription->depTitle ‚Äî $subscription->arrTitle 

            $emoji –¶–µ–Ω–∞ $verb –Ω–∞ $formattedDiff ‚ÇΩ
            üíµ $formattedPrice ‚ÇΩ
            TEXT;
    $telegram->send(TelegramMethod::Send, [
        'chat_id' => $subscription->chatId,
        'text'    => $text,
    ]);
}

/**
 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–µ —Ü–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
 *
 * @param Price[] $prices
 * @param Price[] $oldPrices
 * @return void
 */
function savePrices(array $prices, array $oldPrices): void
{
    global $priceRepository;
    foreach ($prices as $price) {
        empty($oldPrices[$price->companyCode])
            ? $priceRepository->createPrices([$price])
            : $priceRepository->updatePrice($price);
    }
}

$temp = [];
$subsRepository = new SubscriptionsRepository();
$priceRepository = new PriceRepository();
$subscriptions = $subsRepository->get();
$oldPrices = getOldPrices($subscriptions);

foreach ($subscriptions as $subscription) {
    $prices = getPrices($subscription);
    checkPrices($subscription, $prices, $oldPrices[$subscription->id]);
    savePrices($prices, $oldPrices[$subscription->id]);
}
