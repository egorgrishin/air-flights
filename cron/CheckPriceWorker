#!/usr/bin/php
<?php
declare(strict_types=1);

use App\Core\Container;
use App\Core\Telegram;
use App\Enums\Method;
use App\Repositories\PriceRepository;
use App\Services\GetPriceService;
use App\VO\Price;
use App\VO\Subscription;
use PhpAmqpLib\Message\AMQPMessage;

require __DIR__ . '/../vendor/autoload.php';

/**
 * Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¼Ð°ÑÑÐ¸Ð² Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… Ñ†ÐµÐ½ Ð½Ð° Ð±Ð¸Ð»ÐµÑ‚Ñ‹. Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÐºÑÑˆÐ¸Ñ€ÑƒÑŽÑ‚ÑÑ Ð² Redis Ð½Ð° 45 ÑÐµÐºÑƒÐ½Ð´
 *
 * @param Subscription $subscription
 * @return Price[]
 * @throws RedisException
 */
function getPrices(Subscription $subscription): array
{
    global $redis;
    $key = "$subscription->depCode-$subscription->arrCode-$subscription->date";
    if ($redis->ttl($key) !== -2) {
      return getPricesFromCache($subscription, $key);
    }

    $prices = (new GetPriceService())->run(
        $subscription->id,
        $subscription->depCode,
        $subscription->arrCode,
        DateTime::createFromFormat('Y-m-d', $subscription->date),
    );
    $redis->setEx($key, 45, serialize($prices));
    return $prices;
}

/**
 * Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¼Ð°ÑÑÐ¸Ð² Ñ†ÐµÐ½ Ð½Ð° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ Ð¸Ð· ÐºÑÑˆÐ° (Redis)
 * 
 * @param Subscription $subscription
 * @param string $key
 * @return Price[]
 * @throws RedisException
 */
function getPricesFromCache(Subscription $subscription, string $key): array
{
    global $redis;
    /** @var Price[] $cached */
    $cached = unserialize($redis->get($key));
    $prices = [];
    
    foreach ($cached as $price) {
        $prices[$price->companyCode] = new Price(
            $price->companyCode,
            $subscription->id,
            $price->price,
        );
    }
    
    return $prices;
}

/**
 * ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ñ†ÐµÐ½Ñ‹ Ð² Telegram
 *
 * @param Subscription $subscription
 * @param Price[] $prices
 * @param Price[] $oldPrices
 * @return void
 */
function checkPrices(Subscription $subscription, array $prices, array $oldPrices): void
{
    $oldPrices = array_intersect_key($oldPrices, $prices);
    $oldPrices = array_filter(array_column($oldPrices, 'price'));
    $prices = array_filter(array_column($prices, 'price'));
    // Ð•ÑÐ»Ð¸ Ð² Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð½ÐµÑ‚ Ñ†ÐµÐ½Ñ‹, Ñ‚Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð¾
    if (empty($prices)) {
        return;
    }

    $minPrice = min($prices);
    $formattedPrice = number_format($minPrice, 0, ',', ' ');
    // Ð¡Ñ‚Ð°Ñ€Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹, ÐµÑÐ»Ð¸ Ð½Ð¾Ð²Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ð½Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ñ API
    if (empty($oldPrices)) {
        sendSetPrice($subscription, $formattedPrice);
        return;
    }

    $minOldPrice = min($oldPrices);
    if ($minPrice === $minOldPrice) {
        return;
    }
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ñ†ÐµÐ½Ñ‹
    sendUpdatePrice($subscription, $minPrice, $minOldPrice, $formattedPrice);
}

/**
 * ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ñ†ÐµÐ½Ñ‹ Ð½Ð° Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
 *
 * @param Subscription $subscription
 * @param string $formattedPrice
 * @return void
 */
function sendSetPrice(Subscription $subscription, string $formattedPrice): void
{
    $telegram = new Telegram();
    $date = DateTime::createFromFormat('Y-m-d', $subscription->date)->format('d.m.Y');
    $text = <<<TEXT
        ðŸ—“ Ð”Ð°Ñ‚Ð°: $date

        âœˆï¸ $subscription->depTitle â€” $subscription->arrTitle 

        âœ… Ð¦ÐµÐ½Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° 
        ðŸ’µ $formattedPrice â‚½
        TEXT;
    $telegram->send(Method::Send, [
        'chat_id' => $subscription->chatId,
        'text'    => $text,
    ]);
}

/**
 * ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ñ†ÐµÐ½Ñ‹ Ð½Ð° Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
 *
 * @param Subscription $subscription
 * @param float $minPrice
 * @param float $minOldPrice
 * @param string $formattedPrice
 * @return void
 */
function sendUpdatePrice(Subscription $subscription, float $minPrice, float $minOldPrice, string $formattedPrice): void
{
    $telegram = new Telegram();
    $date = DateTime::createFromFormat('Y-m-d', $subscription->date)->format('d.m.Y');
    $verb = $minPrice < $minOldPrice ? 'ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ¸Ð»Ð°ÑÑŒ' : 'ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð»Ð°ÑÑŒ';
    $emoji = $minPrice < $minOldPrice ? 'ðŸ“‰' : 'ðŸ“ˆ';
    $diff = abs($minPrice - $minOldPrice);
    $formattedDiff = number_format($diff, 0, ',', ' ');

    $text = <<<TEXT
        ðŸ—“ Ð”Ð°Ñ‚Ð°: $date

        âœˆï¸ $subscription->depTitle â€” $subscription->arrTitle 

        $emoji Ð¦ÐµÐ½Ð° $verb Ð½Ð° $formattedDiff â‚½
        ðŸ’µ $formattedPrice â‚½
        TEXT;
    $telegram->send(Method::Send, [
        'chat_id' => $subscription->chatId,
        'text'    => $text,
    ]);
}

/**
 * Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
 *
 * @param Price[] $prices
 * @param Price[] $oldPrices
 * @return void
 */
function savePrices(array $prices, array $oldPrices): void
{
    global $repository;
    foreach ($prices as $price) {
        empty($oldPrices[$price->companyCode])
            ? $repository->createPrices([$price])
            : $repository->updatePrice($price);
    }
}

$repository = new PriceRepository();
$redis = Container::redis();
$channel = Container::rabbit()->channel();
$channel->queue_declare('check_price', auto_delete: false);
$now = new DateTime();

$callback = function (AMQPMessage $msg) {
    [$subscription, $oldPrices] = unserialize($msg->getBody());
    $prices = getPrices($subscription);
    checkPrices($subscription, $prices, $oldPrices);
    savePrices($prices, $oldPrices);
};

$channel->basic_qos(0, 1, false);
$channel->basic_consume('check_price', no_ack: true, callback: $callback);

try {
    $channel->consume();
} catch (Throwable $exception) {
    Container::logger()->error($exception);
}
